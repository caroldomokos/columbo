#!/bin/bash
# short intro
read -p "This script will install openstack basic components (keystone,nova,neutron,glance) on a single host. Juno, ubuntu trusty, etc To be completed. Press enter to continue"
# we start by collecting the necessary data to build the system
echo "We start by collecting the necessary data to build the system"
#get the ip address on eth0
ip_address=`ifconfig eth0 2>/dev/null|awk '/inet addr:/ {print $2}'|sed 's/addr://'`
echo "The hostname you want to use:"
read host_name
# overite the /etc/hostname with the new value
sudo bash -c "cat > /etc/hostname" <<EOF
$host_name
EOF
# overwrite /etc/hosts with the new value for our hostname and  fixed ip - not pointing to 127.0.0.1
sudo bash -c "cat > /etc/hosts" <<EOF
$ip_address     $host_name
EOF
#let's update the system
echo "Let's update the system. You will need to have your sudo passwrord ready and type it in when requested"
apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 5EDB1B62EC4926EA 
echo "deb http://ubuntu-cloud.archive.canonical.com/ubuntu" \
  "trusty-updates/juno main" > /etc/apt/sources.list.d/cloudarchive-juno.list
apt-get update && apt-get -y install ubuntu-cloud-keyring && apt-get dist-upgrade -y
#install mariadb with password
echo "Enter the master password to be used for all components (database, rabbitmq, services, etc..)"
read mariadb_pass
export DEBIAN_FRONTEND=noninteractive
debconf-set-selections -v <<EOF
mariadb-server-5.5 mysql-server/root_password password $mariadb_pass
EOF
debconf-set-selections -v <<EOF
mariadb-server-5.5 mysql-server/root_password_again password $mariadb_pass
EOF
apt-get install mariadb-server python-mysqldb -y
# install rabbit mq
apt-get install rabbitmq-server -y
# change guest password
rabbitmqctl change_password guest $mariadb_pass
# Install the Ubuntu Cloud archive keyring and repository
apt-get install ubuntu-cloud-keyring
# install the openstack packages
apt-get install keystone python-keystoneclient glance python-glanceclient nova-api nova-cert nova-conductor nova-consoleauth nova-novncproxy nova-scheduler python-novaclient  nova-compute sysfsutils neutron-server neutron-plugin-ml2 python-neutronclient neutron-plugin-openvswitch-agent neutron-l3-agent neutron-dhcp-agent -y
##############starting keystone###############
sudo bash -c "cat > /etc/keystone/keystone.conf" <<EOF
[DEFAULT]
admin_token=$mariadb_pass
admin_bind_host=$ip_address
EOF

